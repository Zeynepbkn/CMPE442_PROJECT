# Smoking Status Prediction: A Comprehensive ML Pipeline with Explainable AI

This project provides a complete machine learning pipeline for predicting smoking status based on health indicators. It includes comprehensive exploratory data analysis (EDA), model training, hyperparameter optimization, model explainability techniques, and interactive web interfaces.

## üèóÔ∏è Project Structure

### üìä Core Analysis Files

- **`cmpe442_model_training.py`** - **MAIN TRAINING SCRIPT** - Complete ML pipeline including:
  - Comprehensive EDA with 50+ visualizations
  - Model training and comparison of 6 algorithms
  - Hyperparameter optimization using RandomizedSearchCV
  - Model explainability analysis (SHAP, LIME, PDP)
  - Generates all .pkl model files and visualization plots
- **`smoking.csv`** - Original dataset with 55,692 health records and 27 features

### ü§ñ ML Models & Preprocessors (Generated by Training Script)

- **`optimized_random_forest_model.pkl`** - **Trained Random Forest model** (246MB)
  - Generated by `cmpe442_model_trainig.py` after hyperparameter optimization
  - Best performing model with 78.18% F1-Score
  - Used by both Gradio applications for predictions
- **`preprocessor.pkl`** - **Data preprocessing pipeline** (2.7KB)
  - Contains fitted StandardScaler + OneHotEncoder
  - Generated during training, used for consistent data transformation
  - Required for both training and inference phases

### üåê Web Applications

- **`app.py`** - Gradio interface optimized for **Hugging Face Spaces** deployment
- **`appSmoke.py`** - Gradio interface for **local development** and testing
- **`requirements.txt`** - Python dependencies for both applications

### üìà Generated Visualizations

#### EDA & Data Analysis

- **`gender_distribution.png`** - Distribution of gender in dataset
- **`oral_distribution.png`** - Distribution of oral health status
- **`tartar_distribution.png`** - Distribution of dental tartar presence
- **`correlation_heatmap.png`** - Feature correlation matrix heatmap
- **`histograms_matplotlib.png`** - Feature distributions using matplotlib
- **`histograms_seaborn.png`** - Feature distributions using seaborn
- **`boxplots_seaborn.png`** - Boxplots for outlier detection
- **`complete_pairplot.png`** - Comprehensive pairwise feature relationships
- **`scatter_plots_matplotlib.png`** - Scatter plots for selected feature pairs
- **`smoking_relationships.png`** - Smoking status vs important variables

#### Data Preprocessing

- **`before_normalization_scales.png`** - Feature scales before normalization
- **`after_normalization_scales.png`** - Feature scales after normalization

#### Model Performance

- **`model_comparison.png`** - Comparison of 6 different ML algorithms
- **`optimized_rf_confusion_matrix.png`** - Confusion matrix for optimized Random Forest
- **`optimized_rf_feature_importance.png`** - Feature importance from Random Forest
- **`optimized_rf_precision_recall_curve.png`** - Precision-Recall curve
- **`optimized_rf_roc_curve.png`** - ROC curve analysis

#### Explainability (XAI) Results

- **`feature_importance_global.png`** - Global feature importance ranking
- **`permutation_importance_global.png`** - Permutation-based feature importance
- **`shap_summary_global.png`** - SHAP summary plot for all features
- **`shap_bar_global.png`** - SHAP feature importance bar chart
- **`partial_dependence_plots.png`** - Partial Dependence Plots (PDP)
- **`lime_correct_smoker.png`** - LIME explanation for correctly predicted smoker
- **`lime_incorrect_nonsmoker.png`** - LIME explanation for misclassified case

#### Subgroup Analysis

- **`gender_group_feature_importance.png`** - Feature importance comparison by gender
- **`age_group_feature_importance.png`** - Feature importance comparison by age groups
- **`shap_summary_males.png`** - SHAP analysis for male subgroup
- **`shap_summary_females.png`** - SHAP analysis for female subgroup

## üöÄ Quick Start

### Option 1: Use Pre-trained Models (Hugging Face Spaces)

```bash
# Deploy directly to Hugging Face Spaces
# Upload app.py, requirements.txt, and pre-trained model files:
# - optimized_random_forest_model.pkl
# - preprocessor.pkl
# The app.py is specifically optimized for Hugging Face deployment
```

### Option 2: Local Development with Pre-trained Models

```bash
# Clone the repository
git clone <repository-url>
cd CMPE442_PROJECT

# Install dependencies
pip install -r requirements.txt

# Run locally using existing trained models
python appSmoke.py
```

### Option 3: Train Your Own Models (Complete Pipeline)

```bash
# IMPORTANT: This will train new models from scratch
# and overwrite existing .pkl files

# Install additional training dependencies
pip install -r requirements.txt
pip install shap xgboost

# Run the complete ML pipeline (takes ~10-15 minutes)
# This generates all model files and visualizations
python cmpe442_model_training.py

# After training completes, you can run the web apps
python appSmoke.py  # or python app.py
```

## üìã Model Performance

### Final Model: Optimized Random Forest

- **Accuracy**: 82.84%
- **Precision**: 73.31%
- **Recall**: 83.74%
- **F1-Score**: 78.18%
- **ROC AUC**: 83.03%

### Model Comparison Results

| Model               | Accuracy | F1-Score   | ROC AUC | Training Time |
| ------------------- | -------- | ---------- | ------- | ------------- |
| **Random Forest**   | 81.84%   | **75.77%** | 90.56%  | 63.28s        |
| XGBoost             | 77.89%   | 70.51%     | 86.05%  | 6.13s         |
| Neural Network      | 76.35%   | 68.72%     | 84.60%  | 100.94s       |
| Decision Tree       | 76.74%   | 68.47%     | 75.07%  | 5.97s         |
| Logistic Regression | 74.59%   | 66.82%     | 83.07%  | 0.31s         |
| K-Nearest Neighbors | 72.61%   | 62.12%     | 79.56%  | 13.33s        |

## üîç Key Features Analyzed

### Most Important Predictors

1. **Gender (Male)** - Strong predictor of smoking behavior
2. **Hemoglobin levels** - Typically higher in smokers
3. **Height** - Demographic factor with predictive power
4. **GTP (Liver enzyme)** - Affected by smoking
5. **Triglycerides** - Lipid profile indicator

### Health Indicators Included

- **Demographic**: Age, gender, height, weight, waist circumference
- **Cardiovascular**: Systolic/diastolic blood pressure
- **Metabolic**: Cholesterol (HDL, LDL), triglycerides, fasting blood sugar
- **Liver Function**: AST, ALT, GTP enzymes
- **Other**: Hemoglobin, creatinine, vision/hearing tests, dental health

## üî¨ Explainable AI (XAI) Techniques

This project implements multiple XAI methods for model interpretability:

### Global Explanations

- **SHAP (SHapley Additive exPlanations)** - Feature contribution analysis
- **Permutation Importance** - Performance-based feature ranking
- **Feature Importance** - Tree-based importance scores
- **Partial Dependence Plots** - Marginal effect visualization

### Local Explanations

- **LIME (Local Interpretable Model-agnostic Explanations)** - Instance-level explanations
- **Individual SHAP values** - Person-specific feature impacts

### Subgroup Analysis

- **Gender-based analysis** - Different patterns for males vs females
- **Age group analysis** - Varying importance across age ranges

## üìä Dataset Information

- **Total Records**: 55,692 health examinations
- **Features**: 27 variables (24 after preprocessing)
- **Target**: Binary smoking status (0=Non-smoker, 1=Smoker)
- **Class Distribution**: 63.3% Non-smokers, 36.7% Smokers
- **Data Quality**: No missing values, 0 duplicates

## üåê Web Interface Features

Both Gradio applications (`app.py` and `appSmoke.py`) provide:

- **Interactive Input Forms** - Easy-to-use sliders and dropdowns for all health metrics
- **Real-time Predictions** - Instant smoking status classification using trained model
- **Confidence Scores** - Probability estimates for predictions
- **LIME Explanations** - Feature importance for individual predictions
- **User-friendly Interface** - Clean, intuitive design

### Model Integration

Both web applications require the following trained model files:

- **`optimized_random_forest_model.pkl`** - Loaded using joblib for making predictions
- **`preprocessor.pkl`** - Loaded for consistent data transformation before prediction
- Automatic validation of categorical inputs (gender, tartar) against training data

### Key Differences:

- **`app.py`**:
  - Optimized for **Hugging Face Spaces** deployment
  - Includes cloud-specific error handling and logging
  - Ready for public deployment
- **`appSmoke.py`**:
  - Configured for **local development** and testing
  - Enhanced debugging output for development
  - Suitable for local testing and customization

### Prerequisites for Web Apps:

```bash
# Required files (generated by training script):
optimized_random_forest_model.pkl  # 246MB - The trained model
preprocessor.pkl                   # 2.7KB - Data preprocessing pipeline

# Required dependencies:
pip install gradio pandas numpy joblib matplotlib lime scikit-learn
```

## üìà Research Insights

### Medical Correlations Discovered

- **Hemoglobin elevation** in smokers (40% correlation)
- **HDL cholesterol reduction** in smoking individuals
- **Liver enzyme elevation** (AST, ALT, GTP) among smokers
- **Gender-specific patterns** in smoking-related biomarkers

### Demographic Patterns

- **Male smokers**: Higher correlation with liver enzymes and hemoglobin
- **Female smokers**: Different biomarker patterns, especially in lipid profiles
- **Age variations**: Different predictive factors across age groups

## üîß Technical Implementation

### Complete Training Pipeline (`cmpe442_model_training.py`)

The main training script executes the following comprehensive pipeline:

1. **Data Loading & Validation**

   - Loads `smoking.csv` (55,692 records, 27 features)
   - Validates data quality (no missing values found)
   - Checks for duplicates (0 duplicates detected)

2. **Exploratory Data Analysis (EDA)**

   - Generates 50+ visualization plots saved as .png files
   - Statistical summaries for numerical and categorical features
   - Correlation analysis and feature relationship exploration

3. **Data Preprocessing**

   - Creates preprocessing pipeline with StandardScaler + OneHotEncoder
   - Saves fitted pipeline as `preprocessor.pkl` for consistent transformation
   - Stratified train-test split (80/20) preserving class distribution

4. **Model Training & Selection**

   - Trains and compares 6 algorithms using 5-fold cross-validation:
     - Random Forest, XGBoost, Neural Network, Decision Tree, Logistic Regression, KNN
   - Evaluates using multiple metrics: Accuracy, Precision, Recall, F1-Score, ROC AUC

5. **Hyperparameter Optimization**

   - RandomizedSearchCV on best performing model (Random Forest)
   - Optimizes: n_estimators, max_depth, min_samples_split, etc.
   - Saves optimized model as `optimized_random_forest_model.pkl`

6. **Model Explainability Analysis**
   - SHAP (SHapley Additive exPlanations) for global feature importance
   - LIME for local instance-level explanations
   - Permutation importance and Partial Dependence Plots
   - Subgroup analysis by gender and age groups

### Final Model Architecture

- **Algorithm**: Random Forest Classifier (optimized)
- **Model File**: `optimized_random_forest_model.pkl` (246MB)
- **Hyperparameters**:
  - n_estimators=350, max_depth=25, min_samples_split=5
  - min_samples_leaf=2, max_features='log2', class_weight='balanced'
- **Features**: 24 processed features (22 numerical + 2 categorical encoded)
- **Training Strategy**: Stratified sampling, 80/20 train-test split
- **Performance**: 78.18% F1-Score, 82.84% Accuracy on test set

### Model Files Usage

| File                                | Size  | Purpose             | Generated By    | Used By         |
| ----------------------------------- | ----- | ------------------- | --------------- | --------------- |
| `optimized_random_forest_model.pkl` | 246MB | Trained RF model    | Training script | Web apps        |
| `preprocessor.pkl`                  | 2.7KB | Data transformation | Training script | Web apps        |
| `smoking.csv`                       | 6.0MB | Original dataset    | Manual          | Training script |

## üéØ Applications

### Healthcare

- **Early screening** for smoking-related health changes
- **Risk assessment** based on routine health checkups
- **Intervention targeting** for smoking cessation programs

### Research

- **Biomarker discovery** for smoking effects
- **Population health studies**
- **Explainable AI in healthcare** demonstrations

### Education

- **ML pipeline demonstration** from EDA to deployment
- **XAI techniques showcase** for interpretable healthcare AI
- **Real-world healthcare AI** implementation example

## üìú License

MIT License - Feel free to use this project for research, education, or commercial purposes.

## ü§ù Contributing

Contributions are welcome! Please feel free to submit issues, fork the repository, and create pull requests.

## üìû Citation

If you use this project in your research, please cite:

```
@misc{smoking_prediction_xai,
  title={Smoking Status Prediction with Explainable AI},
  author={[Your Name]},
  year={2024},
  url={[Repository URL]}
}
```

## ‚ö†Ô∏è Disclaimer

This model is for research and educational purposes only. It should not be used as a substitute for professional medical advice, diagnosis, or treatment.
